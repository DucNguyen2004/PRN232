@using System.Globalization
@using DTOs
@inject IHttpClientFactory HttpClientFactory

<div class="d-flex mb-4 align-items-start border-bottom pb-3">
    <div>
        <img src="@($"images/{Item?.Product?.Image}")" alt="@Item?.Product?.Name" style="width: 100px;" class="rounded" />
    </div>

    <div class="ms-3 flex-grow-1">
        <h5 class="mb-1">@Item?.Product?.Name</h5>

        @if (Item?.ProductOptions != null && Item.ProductOptions.Any())
        {
            <ul class="mb-2 ps-3">
                <li>Base Price: @FormatPrice(@Item?.Product?.Price)</li>
                @foreach (var option in Item.ProductOptions)
                {
                    <li>@option.Name (@option.Type) [+@FormatPrice(option.DeltaPrice)]</li>
                }
            </ul>
        }

        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-secondary btn-sm"
                    @onclick="() => UpdateQuantity(Item.Id, Item.Quantity - 1)">
                −
            </button>

            <span>@Item.Quantity</span>

            <button class="btn btn-outline-secondary btn-sm"
                    @onclick="() => UpdateQuantity(Item.Id, Item.Quantity + 1)">
                +
            </button>

            <button class="btn btn-link text-danger ms-3 p-0" @onclick="() => RemoveItem(Item.Id)">
                <i class="bi bi-x"></i> Remove
            </button>
        </div>
    </div>

    <div class="text-end" style="min-width: 80px;">
        <strong>@FormatPrice(Total)</strong>
    </div>
</div>

@code {
    [Parameter] public CartItemResponseDto Item { get; set; } = new();
    [Parameter] public EventCallback OnChanged { get; set; }

    private int? Total =>
        ((Item?.Product?.Price ?? 0)
         + (Item?.ProductOptions?.Sum(po => po.DeltaPrice) ?? 0))
         * (Item?.Quantity ?? 0);

    private string FormatPrice(int? price)
    {
        var culture = new CultureInfo("vi-VN");
        return price?.ToString("#,0", culture.NumberFormat) + "đ";
    }

    private async Task UpdateQuantity(int cartItemId, int newQuantity)
    {
        if (newQuantity <= 0)
            return;

        var client = HttpClientFactory.CreateClient("API");
        var response = await client.PutAsJsonAsync($"api/cart/{cartItemId}", newQuantity);

        if (response.IsSuccessStatusCode)
            await OnChanged.InvokeAsync();
    }

    private async Task RemoveItem(int cartItemId)
    {
        var client = HttpClientFactory.CreateClient("API");
        var response = await client.DeleteAsync($"api/cart/{cartItemId}");

        if (response.IsSuccessStatusCode)
            await OnChanged.InvokeAsync();
    }
}
