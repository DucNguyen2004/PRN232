@page "/admin/accounts"
@using DTOs
@using WebApp.Components
@using System.Text.Json
@using Microsoft.AspNetCore.Authorization
@using Blazored.Toast.Services
@using Blazored.LocalStorage;
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject NavigationManager Navigation
@inject Blazored.Toast.Services.IToastService ToastService
@layout AdminLayout
@inject IHttpClientFactory HttpClientFactory
@inject HttpClient Http
@inject IJSRuntime JS

<div class="page-wrapper">
    <div class="container">
        <h3 class="mb-4 text-center">Quản lý tài khoản</h3>

        <div class="filter-bar mb-4">
            <div class="row g-2">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" placeholder="Tìm theo tên người dùng..."
                               @bind="searchTerm" />
                    </div>
                </div>

                <div class="col-md-3">
                    <select class="form-select" @bind="selectedStatus">
                        <option value="">Tất cả trạng thái</option>
                        <option value="ACTIVE">Kích hoạt</option>
                        <option value="INACTIVE">Chưa kích hoạt</option>
                        <option value="DELETED">Đã xóa</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <select class="form-select" @bind="sortField">
                        <option value="Username">Sắp xếp theo tên</option>
                        <option value="CreatedAt">Sắp xếp theo ngày tạo</option>
                        <option value="UpdatedAt">Sắp xếp theo ngày cập nhật</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <button class="btn @(sortDirection == "asc" ? "btn-primary" : "btn-outline-primary") w-100"
                            @onclick="ToggleSortDirection">
                        <i class="bi @(sortDirection == "asc" ? "bi-sort-up" : "bi-sort-down")"></i>
                        @(sortDirection == "asc" ? "Tăng dần" : "Giảm dần")
                    </button>
                </div>

                <div class="col-md-12">
                    <button class="btn btn-primary" @onclick="ApplyFilters">
                        <i class="bi bi-funnel-fill me-1"></i> Lọc
                    </button>
                    <button class="btn btn-outline-secondary ms-2" @onclick="ResetFilters">
                        <i class="bi bi-x-circle me-1"></i> Đặt lại
                    </button>
                </div>

            </div>
        </div>

        <div class="table-wrapper">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th class="sticky-col left">Username</th>
                        <th>Họ tên</th>
                        <th>Số điện thoại</th>
                        <th>Email</th>
                        <th>Ngày sinh</th>
                        <th>Giới tính</th>
                        <th>Trạng thái</th>
                        <th>Ngày tạo</th>
                        <th>Cập nhật lúc</th>
                        <th class="sticky-col right">Thao tác</th>
                    </tr>
                </thead>

                <tbody>
                    @if (loading)
                    {
                        <tr>
                            <td colspan="10" class="text-center py-4">
                                <div class="spinner-border text-primary"></div>
                            </td>
                        </tr>
                    }
                    else if (PagedUsers.Items == null || !PagedUsers.Items.Any())
                    {
                        <tr>
                            <td colspan="10" class="text-center py-4">
                                Không có dữ liệu người dùng nào.
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var user in PagedUsers.Items)
                        {
                            <tr>
                                <td class="sticky-col left">@user.Username</td>
                                <td>@user.Fullname</td>
                                <td>@user.Phone</td>
                                <td>@user.Email</td>
                                <td>@(user.Dob?.ToString("dd-MM-yyyy") ?? "-")</td>
                                <td>@user.Gender</td>
                                <td>
                                    <span class="badge @GetStatusBadgeClass(user.Status)">
                                        @GetStatusDisplayName(user.Status)
                                    </span>
                                </td>
                                <td>@user.CreatedAt.ToString("dd-MM-yyyy HH:mm")</td>
                                <td>@user.UpdatedAt.ToString("dd-MM-yyyy HH:mm")</td>

                                <td class="sticky-col right">
                                    <button class="btn btn-sm btn-info" @onclick="() => OpenEditModal(user)">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
            <small>
                Hiển thị @((CurrentPage - 1) * PageSize + 1) đến @(Math.Min(CurrentPage * PageSize, PagedUsers.TotalItems))
                trong tổng số @PagedUsers.TotalItems người dùng
            </small>

            <nav>
                <ul class="pagination mb-0">

                    <li class="page-item @(CurrentPage == 1 ? "disabled" : "")">
                        <a class="page-link" @onclick="@(() => GoToPage(CurrentPage - 1))">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>

                    @{
                        int startPage = Math.Max(1, CurrentPage - 2);
                        int endPage = Math.Min(startPage + 4, PagedUsers.TotalPages);

                        for (int i = startPage; i <= endPage; i++)
                        {
                            <li class="page-item @(i == CurrentPage ? "active" : "")">
                                <a class="page-link" @onclick="@(() => GoToPage(i))">@i</a>
                            </li>
                        }
                    }

                    <li class="page-item @(CurrentPage == PagedUsers.TotalPages ? "disabled" : "")">
                        <a class="page-link" @onclick="@(() => GoToPage(CurrentPage + 1))">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>

                </ul>
            </nav>

        </div>
    </div>
</div>

<EditForm Model="EditUser" OnValidSubmit="HandleUpdate">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <Modal @bind-IsVisible="IsEditModalOpen" Title="Chỉnh sửa thông tin người dùng">
        <div class="form-group mb-3">
            <label>Tên đăng nhập</label>
            <InputText class="form-control" @bind-Value="EditUser.Username" disabled />
        </div>

        <div class="form-group mb-3">
            <label>Họ và tên</label>
            <InputText class="form-control" @bind-Value="EditUser.Fullname" />
        </div>

        <div class="form-group mb-3">
            <label>Số điện thoại</label>
            <InputText class="form-control" @bind-Value="EditUser.Phone" />
        </div>

        <div class="form-group mb-3">
            <label>Email</label>
            <InputText class="form-control" @bind-Value="EditUser.Email" />
        </div>

        <div class="form-group mb-3">
            <label>Ngày sinh</label>
            <InputDate class="form-control" @bind-Value="EditUser.Dob" />
        </div>

        <div class="form-group mb-3">
            <label>Giới tính</label>
            <InputRadioGroup @bind-Value="EditUser.Gender">
                <div class="form-check form-check-inline">
                    <InputRadio class="form-check-input" Value="@("Male")" />
                    <label class="form-check-label">Nam</label>
                </div>
                <div class="form-check form-check-inline">
                    <InputRadio class="form-check-input" Value="@("Female")" />
                    <label class="form-check-label">Nữ</label>
                </div>
                <div class="form-check form-check-inline">
                    <InputRadio class="form-check-input" Value="@("Other")" />
                    <label class="form-check-label">Khác</label>
                </div>
            </InputRadioGroup>
        </div>

        <div class="form-group mb-3">
            <InputCheckbox class="form-check-input" @bind-Value="_isActive" />
            <label class="form-check-label">Kích hoạt tài khoản</label>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-4">
            <button type="button" class="btn btn-secondary" @onclick="() => IsEditModalOpen = false">Hủy</button>
            <button type="submit" class="btn btn-primary">Lưu</button>
        </div>
    </Modal>
</EditForm>

@code {

    private PaginationResponseDto<UserResponseDto> PagedUsers = new();

    private int CurrentPage = 1;
    private int PageSize = 10;
    private bool loading = true;

    private bool IsEditModalOpen = false;
    private int EditUserId;
    private UserRequestDto EditUser = new();

    // Filters
    private string searchTerm = "";
    private string selectedStatus = "";
    private string sortField = "Username";
    private string sortDirection = "asc";

    private bool _isActive
    {
        get => EditUser.Status == "ACTIVE";
        set => EditUser.Status = value ? "ACTIVE" : "INACTIVE";
    }

    protected override async Task OnInitializedAsync()
    {
        var role = await localStorage.GetItemAsync<string>("userRole");
        if (role != "admin")
        {
            Navigation.NavigateTo("/");
            return;
        }

        await LoadUsers();
    }

    // -----------------------------
    // 🔥 Load users via OData API
    // -----------------------------
    private async Task LoadUsers()
    {
        loading = true;

        try
        {
            var filterParts = new List<string>();

            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                var lower = searchTerm.ToLower();
                filterParts.Add($"(contains(tolower(Username), '{lower}') or contains(tolower(Fullname), '{lower}'))");
            }

            if (!string.IsNullOrWhiteSpace(selectedStatus))
            {
                filterParts.Add($"Status eq '{selectedStatus}'");
            }

            var queryParams = new List<string>();

            if (filterParts.Any())
            {
                queryParams.Add($"$filter={string.Join(" and ", filterParts)}");
            }

            var orderByField = sortField switch
            {
                "CreatedAt" => "CreatedAt",
                "UpdatedAt" => "UpdatedAt",
                _ => "Username"
            };

            queryParams.Add($"$orderby={orderByField} {sortDirection}");

            var skip = (CurrentPage - 1) * PageSize;
            queryParams.Add($"$skip={skip}");
            queryParams.Add($"$top={PageSize}");
            queryParams.Add("$count=true");

            var query = string.Join("&", queryParams);

            var url = $"api/user?{query}";

            var odataResult = await Http.GetFromJsonAsync<List<UserResponseDto>>(url);

            if (odataResult != null)
            {
                var items = odataResult ?? new();
                var totalItems = odataResult.Count;
                var totalPages = (int)Math.Ceiling(totalItems / (double)PageSize);
                if (totalPages == 0) totalPages = 1;

                PagedUsers = new PaginationResponseDto<UserResponseDto>
                {
                    Items = items,
                    TotalItems = totalItems,
                    TotalPages = totalPages
                };
            }
            else
            {
                PagedUsers = new PaginationResponseDto<UserResponseDto>
                {
                    Items = new List<UserResponseDto>(),
                    TotalItems = 0,
                    TotalPages = 1
                };
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"OData Load Error: {ex.Message}");
            PagedUsers = new PaginationResponseDto<UserResponseDto>
            {
                Items = new List<UserResponseDto>(),
                TotalItems = 0,
                TotalPages = 1
            };
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private async Task ApplyFilters()
    {
        CurrentPage = 1;
        await LoadUsers();
    }

    private void ResetFilters()
    {
        searchTerm = "";
        selectedStatus = "";
        sortField = "Username";
        sortDirection = "asc";
        CurrentPage = 1;

        _ = LoadUsers();
    }

    private void ToggleSortDirection()
    {
        sortDirection = sortDirection == "asc" ? "desc" : "asc";
        _ = LoadUsers();
    }

    private async Task GoToPage(int page)
    {
        if (page >= 1 && page <= PagedUsers.TotalPages)
        {
            CurrentPage = page;
            await LoadUsers();
        }
    }

    private void OpenEditModal(UserResponseDto user)
    {
        EditUserId = user.Id;

        EditUser = new UserRequestDto
        {
            Username = user.Username,
            Fullname = user.Fullname,
            Phone = user.Phone,
            Email = user.Email,
            Dob = user.Dob,
            Gender = user.Gender,
            Status = user.Status,
            CreatedAt = user.CreatedAt,
            RoleIds = user.RoleIds?.ToList() ?? new()
        };

        IsEditModalOpen = true;
    }

    private async Task HandleUpdate()
    {
        EditUser.Password = "";

        var res = await Http.PutAsJsonAsync($"api/user/{EditUserId}", EditUser);

        if (res.IsSuccessStatusCode)
        {
            ToastService.ShowSuccess("Cập nhật người dùng thành công");
            IsEditModalOpen = false;

            await LoadUsers();
        }
        else
        {
            ToastService.ShowError("Cập nhật thất bại");
        }
    }

    private string GetStatusBadgeClass(string status)
    {
        return status.ToUpper() switch
        {
            "ACTIVE" => "bg-success",
            "INACTIVE" => "bg-warning",
            _ => "bg-secondary"
        };
    }

    private string GetStatusDisplayName(string status)
    {
        return status.ToUpper() switch
        {
            "ACTIVE" => "Kích hoạt",
            "INACTIVE" => "Chưa kích hoạt",
            _ => status
        };
    }
}
