@page "/cart"
@using DTOs
@using Components
@using System.Globalization
@using Microsoft.AspNetCore.Components.Authorization
@using WebApp.Components.Cart
@using WebApp.States
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthProvider

<div class="container my-5">
    <div class="row">
        <div class="col-lg-8">
            <div class="flex">
                <h3 class="mb-4">Cart</h3>
                <button class="btn btn-outline-danger mb-3" @onclick="ClearCart">
                    <i class="bi bi-trash3"></i> Clear Cart
                </button>
            </div>

            @foreach (var item in cartData?.CartItems ?? new List<CartItemResponseDto>())
            {
                <CartItem Item="item" OnChanged="LoadCart" />
            }
        </div>

        <div class="col-lg-4">
            <CartSummary CartItems="cartData?.CartItems ?? new()" />
        </div>
    </div>
</div>

@code {
    private UserCartResponseDto? cartData;

    protected override async Task OnInitializedAsync()
    {
        var isAuth = await IsUserAuthenticatedAsync();

        if (!isAuth)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadCart();
    }

    private async Task LoadCart()
    {
        var client = HttpClientFactory.CreateClient("API");
        var response = await client.GetFromJsonAsync<UserCartResponseDto>("api/cart");

        if (response is not null)
        {
            cartData = response;
        }
    }

    private async Task ClearCart()
    {
        var client = HttpClientFactory.CreateClient("API");
        var response = await client.DeleteAsync("api/cart/clear");

        if (response.IsSuccessStatusCode)
        {
            await LoadCart();
        }
    }

    private string FormatPrice(int? price)
    {
        var culture = new CultureInfo("vi-VN");
        return price?.ToString("#,0", culture.NumberFormat) + "đ";
    }
    private async Task<bool> IsUserAuthenticatedAsync()
    {
        var state = await AuthProvider.GetAuthenticationStateAsync();
        return state.User.Identity?.IsAuthenticated ?? false;
    }
}