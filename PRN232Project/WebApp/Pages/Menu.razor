@page "/menu"
@using DTOs
@using WebApp.Components.Menu
@using System.Globalization

@inject NavigationManager Navigation
@inject HttpClient Http

<PageTitle>Thực đơn - Việt Coffee</PageTitle>

<section class="menu-section">
    <div class="container py-5">
        @if (Categories == null || FilteredProducts == null)
        {
            <p>Loading...</p>
        }
        else
        {
            <h2 class="section-title mb-4">Thực đơn</h2>

            <!-- FILTER BAR -->
            <div class="menu-filter-bar card p-3 mb-4 shadow-sm">
                <form class="row g-2 align-items-end" @onsubmit="OnFilterSubmit">
                    
                    <!-- CATEGORY FILTER -->
                    <div class="col-12 col-md-3">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-tags me-1"></i> Danh mục
                        </label>

                        <!-- IMPORTANT: Bind as string so empty option works -->
                        <select class="form-select" @bind="selectedCategoryIdString">
                            <option value="">Tất cả</option>
                            @foreach (var category in Categories)
                            {
                                <option value="@category.Id">@category.Name</option>
                            }
                        </select>
                    </div>

                    <!-- SEARCH -->
                    <div class="col-12 col-md-3 mt-2 mt-md-0">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-search me-1"></i> Tìm kiếm
                        </label>
                        <input class="form-control" placeholder="Tên sản phẩm..."
                               @bind="searchTerm" />
                    </div>

                    <!-- ACTION BUTTONS -->
                    <div class="col-6 col-md-1 mt-2 mt-md-0 d-flex gap-2">
                        <button type="submit" class="btn btn-accent w-100">
                            <i class="bi bi-funnel"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary w-100"
                                @onclick="ResetFilters">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>

                </form>
            </div>

            <!-- PRODUCT LIST -->
            <div class="row g-4">
                @foreach (var product in FilteredProducts)
                {
                    if (product.Status == "ACTIVE"){
                        <MenuItem Product="@product" />
                    }
                }
            </div>
        }
    </div>
</section>

@code {

    public List<ProductResponseDto>? FilteredProducts;
    public List<CategoryResponseDto>? Categories;

    // Store category as string from <select>
    private string? selectedCategoryIdString = null;

    // Convert to int? for OData
    private int? SelectedCategoryId =>
        int.TryParse(selectedCategoryIdString, out var id) ? id : null;

    private string searchTerm = "";
    private int? minPrice = null;
    private int? maxPrice = null;

    protected override async Task OnInitializedAsync()
    {
        Categories = await Http.GetFromJsonAsync<List<CategoryResponseDto>>("api/category");
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        string odataUrl = BuildODataQuery();

        FilteredProducts = await Http.GetFromJsonAsync<List<ProductResponseDto>>(odataUrl)
                           ?? new List<ProductResponseDto>();

        StateHasChanged();
    }

    private string BuildODataQuery()
    {
        var filters = new List<string>();

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var escaped = searchTerm.Replace("'", "''");
            filters.Add($"contains(Name,'{escaped}')");
        }

        if (SelectedCategoryId is not null)
            filters.Add($"Category/Id eq {SelectedCategoryId}");

        if (minPrice != null)
            filters.Add($"Price ge {minPrice}");

        if (maxPrice != null)
            filters.Add($"Price le {maxPrice}");

        // Only show active products
        filters.Add("Status eq 'ACTIVE'");

        string filterBlock = filters.Count > 0
            ? $"$filter={string.Join(" and ", filters)}"
            : "";

        string query = "api/product";

        if (!string.IsNullOrWhiteSpace(filterBlock))
            query += "?" + filterBlock;

        return query;
    }

    private async Task OnFilterSubmit()
    {
        await LoadProducts();
    }

    private async Task ResetFilters()
    {
        selectedCategoryIdString = null; // FIXED
        searchTerm = "";
        minPrice = null;
        maxPrice = null;

        await LoadProducts();
    }
}
